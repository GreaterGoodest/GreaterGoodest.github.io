<!doctype html>
<html lang="en-us">
  <head>
    <title>ELF Science Part 1 // Goodest Blog</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.89.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Ryan Good" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://GreaterGoodest.github.io/css/main.min.88e7083eff65effb7485b6e6f38d10afbec25093a6fac42d734ce9024d3defbd.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ELF Science Part 1"/>
<meta name="twitter:description" content="One of the most difficult parts of creating offensive tools is preventing detection. Even if you employ the most advanced methodologies available, your tool will eventually be detected. At this point, the goal becomes making the analyst/reversers life as difficult as possible.
There are a number of ways of doing this, including breaking your payload up into smaller chunks to limit exposure and loading functionality at runtime. However, this post will focus on a different method."/>

    <meta property="og:title" content="ELF Science Part 1" />
<meta property="og:description" content="One of the most difficult parts of creating offensive tools is preventing detection. Even if you employ the most advanced methodologies available, your tool will eventually be detected. At this point, the goal becomes making the analyst/reversers life as difficult as possible.
There are a number of ways of doing this, including breaking your payload up into smaller chunks to limit exposure and loading functionality at runtime. However, this post will focus on a different method." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://GreaterGoodest.github.io/post/elf_science_p1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-12T13:00:44-06:00" />
<meta property="article:modified_time" content="2021-11-12T13:00:44-06:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://GreaterGoodest.github.io"><img class="app-header-avatar" src="/images/greatergoodest.jpg" alt="Ryan Good" /></a>
      <h1>Goodest Blog</h1>
      <p>Blogging about netsec and malware stuff</p>
      <div class="app-header-social">
        
          <a href="https://www.linkedin.com/in/ryanagood/" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>LinkedIn</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
          <a href="https://github.com/GreaterGoodest/" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>GitHub</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/GreaterGoodest" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">ELF Science Part 1</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Nov 12, 2021
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>One of the most difficult parts of creating offensive tools is preventing detection. Even if you employ the most advanced methodologies available, your tool will eventually be detected. At this point, the goal becomes making the analyst/reversers life as difficult as possible.</p>
<p>There are a number of ways of doing this, including breaking your payload up into smaller chunks to limit exposure and <a href="https://x-c3ll.github.io/posts/fileless-memfd_create/">loading functionality at runtime</a>. However, this post will focus on a different method. &ldquo;Hardening&rdquo; binary payloads.</p>
<p>Binary hardening can involve a variety of techniques. For example, flexibility in binary formats allows for alterations that can confuse reversing tools. Another possible hardening procedure is <strong>encryption</strong>.</p>
<p>Encrypting our binary will make it far more difficult for an analyst to examine it, as they will no longer be able to use their tools to dissaseemble it. However, this may also increase the chances of the payload being detected due to <a href="https://www.cyberbit.com/blog/endpoint-security/malware-terms-code-entropy/">entropy</a>.</p>
<p>An astute reader may immediately ask the question, &ldquo;But if the binary is encrypted, how can it execute?&rdquo;. The short answer is: <em>it can&rsquo;t</em>. However, we can fix this by having the binary decrypt itself. This series of posts, and the tool developed as a result, will focus on automating the ability to do just that.</p>
<hr>
<p>A possible way to do this would be to encrypt all functionality besides the entrypoint, then have the process decrypt it&rsquo;s other functions at the beginning of execution. Below is an example of how we could accomplish the encryption portion of this using Python:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">import</span> sys

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">crypt</span>(binary: str, start: int, stop: int):
    <span style="color:#e6db74">&#34;&#34;&#34;Encrypts the provided binary from start address to stop address&#34;&#34;&#34;</span>
    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Encrypting </span><span style="color:#e6db74">{</span>binary<span style="color:#e6db74">}</span><span style="color:#e6db74"> from address </span><span style="color:#e6db74">{</span>start<span style="color:#e6db74">}</span><span style="color:#e6db74"> to address </span><span style="color:#e6db74">{</span>stop<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
    size <span style="color:#f92672">=</span> stop <span style="color:#f92672">-</span> start                 <span style="color:#75715e">#size of space to be encrypted</span>
    <span style="color:#66d9ef">with</span> open(binary, <span style="color:#e6db74">&#39;rb+&#39;</span>) <span style="color:#66d9ef">as</span> f:
        f<span style="color:#f92672">.</span>seek(start)                   <span style="color:#75715e">#move file pointer to start address</span>
        data <span style="color:#f92672">=</span> bytearray(f<span style="color:#f92672">.</span>read(size))  <span style="color:#75715e">#read in data to be encrypted</span>
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(data)):      <span style="color:#75715e">#encrypt data using single byte xor</span>
            data[i] <span style="color:#f92672">=</span> data[i] <span style="color:#f92672">^</span> <span style="color:#ae81ff">0xFA</span>
        data <span style="color:#f92672">=</span> bytes(data)              <span style="color:#75715e">#convert back to bytes for writing to binary</span>

        f<span style="color:#f92672">.</span>seek(start)                   <span style="color:#75715e">#return to start address</span>
        f<span style="color:#f92672">.</span>write(data)                   <span style="color:#75715e">#replace data with encrypted version</span>


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>:
        print(<span style="color:#e6db74">&#34;Usage: ./crypt [binary] [start address] [stop address]&#34;</span>)
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)

    binary <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]                <span style="color:#75715e">#binary file name</span>
    <span style="color:#66d9ef">try</span>:
        start <span style="color:#f92672">=</span> int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])        <span style="color:#75715e">#encryption start address</span>
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span>:
        start <span style="color:#f92672">=</span> int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">16</span>)

    <span style="color:#66d9ef">try</span>:
        stop <span style="color:#f92672">=</span> int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">3</span>])         <span style="color:#75715e">#encryption end address</span>
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span>:
        stop <span style="color:#f92672">=</span> int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">3</span>], <span style="color:#ae81ff">16</span>)

    crypt(binary, start, stop)
</code></pre></div><p>The encryption script begins by retrieving the relevant values from the command line invocation. This includes the name of the binary to encrypt, the start address of encryption, and the end address of encryption. If any of these values are missing, we will print usage instructions and exit with a non-zero exit code to signify an error occurred. The start address and stop address will then be converted to integers. They can be provided in either base 10 or base 16 format, thanks to the added exception handling.</p>
<p>Now that we have our values, we can pass them to the encryption function (crypt). The encryption function calculates the length of data to encrypt. It then opens the binary to modify it appropriately. Once the binary is open, the file pointer is moved to the start address via seek() and then the data to encrypt is read in. We convert this data to a bytearray object, as bytes are immutable in python. Now that we have a byte array, we can modify it via our &ldquo;encryption&rdquo; method (single byte xor). We&rsquo;ll use a fixed key of 0xFA in this example.</p>
<p>Once encryption is complete, the modified data can be converted back into bytes and written back to the binary.</p>
<hr>
<p>Next we&rsquo;ll need a basic binary to demonstrate our encryption on:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">encrypt_me</span>(){
    puts(<span style="color:#e6db74">&#34;Sneaky function!&#34;</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
    puts(<span style="color:#e6db74">&#34;Main function&#34;</span>);
    encrypt_me();
}
</code></pre></div><p>Compilation and execution can be seen below:</p>
<p><img src="/images/basic-bin.gif" alt="Compilation GIF"></p>
<p>Our compilation command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gcc -g -no-pie -o main main.c
</code></pre></div><p>Uses the following flags</p>
<ul>
<li><strong>-g</strong> to enable symbols</li>
<li><strong>-no-pie</strong> to disable position independence</li>
</ul>
<p>Disabling position independence will greatly simplify the following steps (Handling <a href="https://access.redhat.com/blogs/766093/posts/1975793">PIE</a> may be the subject of a later post).</p>
<p>TODO: Talk about read write execute segment being flaggable, so use mprotect instead.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
